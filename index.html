<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FishingRPG - Your Fishing Adventure</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #343650;
            color: #f7f5ec;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 500px;
            margin: 60px auto 0 auto;
            padding: 30px 20px;
            border-radius: 18px;
            box-shadow: 0 2px 24px #0007;
            background: #27293a;
        }
        h1 {
            text-align: center;
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        .player-stats {
            margin-top: 22px;
            margin-bottom: 32px;
            background: #292b3a;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        .player-stats span {
            font-weight: 600;
            margin: 0 7px;
            font-size: 1rem;
        }
        .game-layout {
            min-height: 120px;
        }
        .shop-item {
            background: #232240;
            border-radius: 9px;
            margin-bottom: 17px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 9px 14px;
            box-shadow: 0 1px 4px #0004;
        }
        .shop-item-info {
            display: flex;
            flex-direction: column;
        }
        .shop-item-name {
            font-weight: 700;
            font-size: 1.03rem;
        }
        .shop-item-desc {
            font-size: .94rem;
            color: #ffca80;
        }
        .shop-item-price {
            font-size: 1rem;
            font-weight: 500;
            margin-right: 12px;
        }
        .sell-button {
            margin-left: 7px;
            background: #ffad36;
            color: #282828;
            padding: 6px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 1px 3px #0002;
            transition: background 0.2s;
        }
        .sell-button:hover {
            background: #e67300;
            color: #fff;
        }
        .message {
            margin: 14px 0;
            text-align: center;
            font-weight: 600;
        }
        .message.success {
            color: #85ff8b;
        }
        .message.fail {
            color: #e97474;
        }
        /* New/undo notification style */
        .critical-message {
            background: #e97474;
            color: #fff;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            padding: 18px;
            border-radius: 14px;
            max-width: 440px;
            margin: 36px auto 18px auto;
        }
        .undo-btn {
            background: #fff;
            color: #e97474;
            padding: 6px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .undo-btn:hover {
            background: #e97474;
            color: #fff;
            border: 1.5px solid #fff;
        }
    </style>
</head>
<body>
    <noscript>
        <div style="background:#e97474;color:#fff;text-align:center;padding:18px;border-radius:14px;max-width:440px;margin:36px auto 0;font-weight:700;font-size:1.1rem;">
            JavaScript is required! Please enable JavaScript to play FishingRPG.
        </div>
    </noscript>
    <div class="container" id="mainContainer" style="display:none;">
        <h1>FishingRPG <span aria-label="fishing">ðŸŽ£</span></h1>
        <div class="player-stats" id="playerStats">
            <span id="stat-gold">Gold: 0</span>
            <span id="stat-totalfish"></span>
        </div>
        <div class="game-layout">
            <div id="sellContent"></div>
        </div>
    </div>
    <div id="criticalMsgArea"></div>
    <script>
        // Show game area when DOM is ready
        document.addEventListener("DOMContentLoaded", function() {
            var cont = document.getElementById('mainContainer');
            if(cont) cont.style.display = '';
        });

        // Load/save helpers
        const LS_KEY = "fishingRPG_save";
        // Helper to clone objects deeply (inventory, etc)
        function deepClone(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        function saveGame() {
            // Save only if not in undo state
            if (window.preventNextSave) {
                window.preventNextSave = false;
                return;
            }
            try {
                localStorage.setItem(LS_KEY, JSON.stringify(window.gameState));
            } catch(e){}
        }
        function loadGame() {
            try {
                let data = localStorage.getItem(LS_KEY);
                if(!data) return null;
                return JSON.parse(data);
            } catch(e){return null;}
        }

        // State and DB initialization/recovery
        let userSavedData = loadGame();

        if (!userSavedData) {
            // Give new user default starter
            window.gameState = {
                inventory: { Trout: 3, Bass: 2, Salmon: 1 },
                gold: 42,
                totalFish: 6,
                level: 2
            };
            saveGame();
        } else {
            window.gameState = userSavedData;
        }
        // Fish DB (assume unchanged)
        if (typeof window.fishDatabase === "undefined") {
            window.fishDatabase = [
                { name: "Trout", icon: "ðŸŸ", gold: 15 },
                { name: "Bass", icon: "ðŸ ", gold: 21 },
                { name: "Salmon", icon: "ðŸ¡", gold: 33 }
            ];
        }
        // For undo functionality
        let lastBeforeSellState = null;

        if (typeof window.showMessage === "undefined") {
            window.showMessage = function(msg, type) {
                const statDiv = document.getElementById('playerStats');
                if (!statDiv) return alert(msg);
                let oldMsg = statDiv.querySelector('.message');
                if (oldMsg) oldMsg.remove();
                const el = document.createElement('div');
                el.className = 'message' + (type ? (' ' + type) : '');
                el.textContent = msg;
                statDiv.appendChild(el);
                setTimeout(() => {
                    if (el.parentNode) el.parentNode.removeChild(el);
                }, 2500);
            }
        }
        if (typeof window.renderShop === "undefined") window.renderShop = function() {};

        // stat UI update
        function updateUI() {
            document.getElementById('stat-gold').textContent = `Gold: ${window.gameState.gold}`;
            if ('totalFish' in window.gameState) {
                document.getElementById('stat-totalfish').textContent = ` | Total Fish Caught: ${window.gameState.totalFish}`;
            } else {
                document.getElementById('stat-totalfish').textContent = '';
            }
        }
        window.updateUI = updateUI;

        // Undo "critical" warning UI
        function showCriticalMessage(msg, undoCallback) {
            const area = document.getElementById("criticalMsgArea");
            area.innerHTML = `
                <div class="critical-message" role="alert">
                    ${msg}
                    <br>
                    ${undoCallback ? '<button class="undo-btn" id="undoBtn">Undo</button>' : ""}
                </div>
            `;
            if (undoCallback) {
                document.getElementById("undoBtn").onclick = function() {
                    undoCallback();
                    area.innerHTML = "";
                };
            }
        }
        function clearCriticalMessage() {
            document.getElementById("criticalMsgArea").innerHTML = "";
        }

        // Expose for inline handlers
        window.sellFish = sellFish;
        window.sellAllFish = sellAllFish;

        // Render sell panel
        function renderSell() {
            clearCriticalMessage();
            const sellContent = document.getElementById('sellContent');
            if (!sellContent) return;

            const fishNames = Object.keys(gameState.inventory).sort();

            if (fishNames.length === 0) {
                sellContent.innerHTML = '<p style="color: #999; text-align: center; padding: 28px 0 22px;">No fish to sell!</p>';
                return;
            }

            let html = `
                <button class="sell-button"
                        style="margin-bottom: 15px; background:#e67300;"
                        onclick="sellAllFish()">
                    Sell ALL Fish
                </button>
                <p style="margin-bottom: 15px; color: #cbc8be;">Sell all of a fish type, or sell EVERYTHING with the button above.</p>
            `;

            fishNames.forEach(fishName => {
                const fish = fishDatabase.find(f => f.name === fishName);
                if (!fish) return;
                const count = gameState.inventory[fishName];
                const totalValue = fish.gold * count;
                html += `
                    <div class="shop-item">
                        <div class="shop-item-info">
                            <div class="shop-item-name">${fish.icon} ${fishName} (${count}x)</div>
                            <div class="shop-item-desc">${fish.gold} gold each</div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span class="shop-item-price">${totalValue} gold total</span>
                            <button class="sell-button" onclick="sellFish('${fishName}', 1)">Sell 1</button>
                            <button class="sell-button" onclick="sellFish('${fishName}', ${count})">Sell All</button>
                        </div>
                    </div>
                `;
            });

            sellContent.innerHTML = html;
        }

        function sellFish(fishName, quantity) {
            clearCriticalMessage();
            const fish = fishDatabase.find(f => f.name === fishName);
            if (!fish) return;
            const count = gameState.inventory[fishName] || 0;
            const sellCount = Math.min(quantity, count);
            if (sellCount > 0) {
                // Save last state for undo
                lastBeforeSellState = deepClone(gameState);
                gameState.inventory[fishName] -= sellCount;
                if (gameState.inventory[fishName] <= 0) delete gameState.inventory[fishName];
                const goldEarned = fish.gold * sellCount;
                gameState.gold += goldEarned;
                showMessage(`Sold ${sellCount}x ${fishName} for ${goldEarned} gold!`, 'success');
                updateUI();
                renderSell();
                saveGame();
                renderShop();
            }
        }

        function sellAllFish() {
            clearCriticalMessage();
            let totalGold = 0;
            let soldAny = false;
            for (const fishName in gameState.inventory) {
                const fish = fishDatabase.find(f => f.name === fishName);
                if (fish) {
                    const qty = gameState.inventory[fishName];
                    totalGold += qty * fish.gold;
                    soldAny = true;
                }
            }

            if (!soldAny) {
                showMessage('No fish to sell!', 'fail');
                return;
            }

            // Save previous gameState for undo in-memory
            lastBeforeSellState = deepClone(gameState);

            gameState.gold += totalGold;
            gameState.inventory = {};

            // Show critical warning with undo
            showCriticalMessage(
                "You sold ALL your fish for " + totalGold + " gold! <br>If you made a mistake, click UNDO below.",
                function undoSellAll() {
                    if (lastBeforeSellState) {
                        window.gameState = deepClone(lastBeforeSellState);
                        window.preventNextSave = true;
                        updateUI();
                        renderSell();
                        renderShop();
                        saveGame();
                        lastBeforeSellState = null;
                        showMessage("Sell All undone! Your fish are back.", "success");
                    }
                }
            );

            updateUI();
            renderSell();
            renderShop();
            saveGame();
        }

        // Initial render
        document.addEventListener("DOMContentLoaded", () => {
            updateUI();
            renderSell();
        });
    </script>
</body>
</html>
