<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FishingRPG - Your Fishing Adventure</title>
    <style>
    </style>
</head>
<body>
    <div class="container">
        <div class="game-layout">
        </div>
    </div>
    
    <script>
        function renderSell() {
            const sellContent = document.getElementById('sellContent');
            const fishNames = Object.keys(gameState.inventory).sort();

            if (fishNames.length === 0) {
                sellContent.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No fish to sell!</p>';
                return;
            }

            let html = `
                <button class="sell-button"
                        style="margin-bottom: 15px; background:#e67300;"
                        onclick="sellAllFish()">
                    Sell ALL Fish
                </button>
                <p style="margin-bottom: 15px; color: #666;">Sell all of a fish type, or sell EVERYTHING with the button above.</p>
            `;

            fishNames.forEach(fishName => {
                const fish = fishDatabase.find(f => f.name === fishName);
                if (!fish) return;

                const count = gameState.inventory[fishName];
                const totalValue = fish.gold * count;

                html += `
                    <div class="shop-item">
                        <div class="shop-item-info">
                            <div class="shop-item-name">${fish.icon} ${fishName} (${count}x)</div>
                            <div class="shop-item-desc">${fish.gold} gold each</div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span class="shop-item-price">${totalValue} gold total</span>
                            <button class="sell-button" onclick="sellFish('${fishName}', 1)">Sell 1</button>
                            <button class="sell-button" onclick="sellFish('${fishName}', ${count})">Sell All</button>
                        </div>
                    </div>
                `;
            });

            sellContent.innerHTML = html;
        }

        function sellFish(fishName, quantity) {
            const fish = fishDatabase.find(f => f.name === fishName);
            if (!fish) return;
            const count = gameState.inventory[fishName] || 0;
            const sellCount = Math.min(quantity, count);
            if (sellCount > 0) {
                gameState.inventory[fishName] -= sellCount;
                if (gameState.inventory[fishName] <= 0) delete gameState.inventory[fishName];
                const goldEarned = fish.gold * sellCount;
                gameState.gold += goldEarned;
                showMessage(`Sold ${sellCount}x ${fishName} for ${goldEarned} gold!`, 'success');
                updateUI();
                renderSell();
                saveGame();
                renderShop();
            }
        }

        function sellAllFish() {
            let totalGold = 0;
            let soldAny = false;

            for (const fishName in gameState.inventory) {
                const fish = fishDatabase.find(f => f.name === fishName);
                if (fish) {
                    const qty = gameState.inventory[fishName];
                    totalGold += qty * fish.gold;
                    soldAny = true;
                }
            }

            if (!soldAny) {
                showMessage('No fish to sell!', 'fail');
                return;
            }

            gameState.gold += totalGold;
            gameState.inventory = {};

            showMessage(`Sold ALL fish for ${totalGold} gold!`, 'success');

            updateUI();
            renderSell();
            renderShop();
            saveGame();
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCnwHvRXlLzC122GIusPgwlboJA2qdRKcE",
            authDomain: "fishingrpg.firebaseapp.com",
            databaseURL: "https://fishingrpg-default-rtdb.firebaseio.com/",
            projectId: "fishingrpg",
            storageBucket: "fishingrpg.firebasestorage.app",
            messagingSenderId: "87406758660",
            appId: "1:87406758660:web:4c540fdcf26f1a5a6dde51",
            measurementId: "G-4BKFFKFQSM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let username = localStorage.getItem('fishingRPG_username');
        if (!username) {
            username = prompt("Enter your username for the global leaderboard:") || "";
            username = username.trim();
            if (!username) {
                username = "Player" + Math.floor(Math.random() * 100000);
            }
            if (username.length > 16) username = username.slice(0, 16);
            localStorage.setItem('fishingRPG_username', username);
        }
        window.fishingUsername = username;

        function syncLeaderboardNow() {
            const gs = window.gameState;
            if (!gs) return;
            const biggest = (window.getBiggestCatchKg && window.getBiggestCatchKg()) || 0;
            let safeName = username.replace(/[^a-zA-Z0-9_-]/g, "_");
            if (!safeName) safeName = "player";
            const userRef = ref(db, "leaderboard/" + safeName);
            set(userRef, {
                username: username,
                level: gs.level || 1,
                totalFish: gs.totalFish || 0,
                gold: gs.gold || 0,
                biggestCatchKg: biggest || 0,
                updatedAt: Date.now()
            }).catch(err => console.error("Error syncing leaderboard:", err));
        }

        let syncTimeout = null;
        function scheduleLeaderboardSync() {
            if (syncTimeout) clearTimeout(syncTimeout);
            syncTimeout = setTimeout(syncLeaderboardNow, 2000);
        }
        window.scheduleLeaderboardSync = scheduleLeaderboardSync;

        const lbRef = ref(db, "leaderboard");
        const lbQuery = query(lbRef, orderByChild("level"), limitToLast(100));
        onValue(lbQuery, snapshot => {
            const val = snapshot.val() || {};
            const players = Object.values(val);
            players.sort((a, b) => {
                const la = a.level || 0, lbv = b.level || 0;
                if (lbv !== la) return lbv - la;
                const fa = a.totalFish || 0, fb = b.totalFish || 0;
                if (fb !== fa) return fb - fa;
                const ba = a.biggestCatchKg || 0, bb = b.biggestCatchKg || 0;
                return bb - ba;
            });
            if (window.setLeaderboardData) window.setLeaderboardData(players);
        });

        if (window.updateUI) window.updateUI();

    </script>
</body>
</html>
